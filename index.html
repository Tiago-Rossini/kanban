<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban de Expedi√ß√£o por Urg√™ncia de Giro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Custom styles for the application */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Animation for overdue cards */
        @keyframes pulse-border-dark {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7);
            }
            50% {
                box-shadow: 0 0 0 4px rgba(255, 82, 82, 0);
            }
        }
        .card-overdue {
            animation: pulse-border-dark 2s infinite;
        }

        /* Styling for drag-and-drop */
        .kanban-card.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .drop-zone {
            transition: background-color 0.2s ease-in-out;
            min-height: 150px; /* Ensure drop zones are always targetable */
        }
        .drop-zone.drag-over {
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* Custom scrollbar for history */
        #history-log::-webkit-scrollbar {
            width: 6px;
        }
        #history-log::-webkit-scrollbar-track {
            background: transparent;
        }
        #history-log::-webkit-scrollbar-thumb {
            background-color: #475569; /* slate-600 */
            border-radius: 20px;
            border: 3px solid transparent;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">

    <div class="container mx-auto p-4 lg:p-6">
        <!-- Header -->
        <header class="mb-6 text-center lg:text-left">
            <div class="flex items-center justify-center lg:justify-start gap-3 relative group">
                <h1 class="text-3xl font-extrabold text-white">Kanban de Expedi√ß√£o Inteligente</h1>
                <div class="cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-info-circle-fill text-slate-500 group-hover:text-sky-400 transition-colors" viewBox="0 0 16 16">
                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                    </svg>
                    <div class="absolute top-full left-0 mt-2 w-72 p-3 bg-slate-800 border border-slate-700 rounded-lg shadow-xl text-sm text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-20">
                        <h4 class="font-bold text-white mb-2">Legenda de Cores por Urg√™ncia</h4>
                        <ul id="color-legend-list" class="space-y-1">
                            <!-- Legend items will be injected by JS -->
                        </ul>
                        <div class="absolute left-4 top-[-8px] w-4 h-4 bg-slate-800 border-t border-l border-slate-700 transform rotate-45"></div>
                    </div>
                </div>
            </div>
            <p class="text-slate-400 mt-1">Gerencie o fluxo de sa√≠da do seu estoque com foco na urg√™ncia.</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Main Kanban Board -->
            <main class="flex-grow">
                <div id="kanban-board" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-5">
                    <!-- Columns will be dynamically generated here -->
                </div>
            </main>

            <!-- Sidebar with Dashboard -->
            <aside class="w-full lg:w-80 lg:flex-shrink-0 bg-slate-800/50 backdrop-blur-sm border border-slate-700 p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4 border-b border-slate-700 pb-2 text-white">üìä Term√¥metro de Giro</h2>
                
                <div class="mb-6">
                    <h3 class="font-semibold mb-2 text-center text-slate-300">Distribui√ß√£o do Estoque</h3>
                    <canvas id="stockDistributionChart"></canvas>
                </div>

                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center p-2 bg-slate-700/50 rounded">
                        <span class="font-semibold">Dias M√©dios em Estoque:</span>
                        <span id="avgDaysInStock" class="font-bold text-lg text-sky-400">--</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-slate-700/50 rounded">
                        <span class="font-semibold">Meta Redu√ß√£o Parado:</span>
                        <span class="font-bold text-emerald-400">15%</span>
                    </div>
                     <div class="flex justify-between items-center p-2 bg-red-800/30 rounded border border-red-700/50">
                        <span class="font-semibold text-red-300">Lotes em "√öltima Chamada":</span>
                        <span id="lastCallCount" class="font-bold text-lg text-red-400">--</span>
                    </div>
                </div>
                
                 <div class="mt-6">
                    <button id="add-item-btn" class="w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-500 transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/></svg>
                        Adicionar Novo Lote
                    </button>
                </div>

                <div class="mt-6 pt-4 border-t border-slate-700">
                    <h3 class="text-lg font-bold mb-3 text-white">üìú Hist√≥rico de Movimenta√ß√µes</h3>
                    <div id="history-log" class="space-y-2 text-xs h-48 overflow-y-auto pr-2">
                        <p class="text-slate-500 italic">Nenhuma movimenta√ß√£o registrada.</p>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Modal for adding a new item -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-white">Adicionar Novo Lote</h2>
            <form id="add-item-form">
                <div class="mb-4">
                    <label for="sku" class="block text-sm font-medium text-slate-300">SKU / C√≥digo</label>
                    <input type="text" id="sku" name="sku" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-white shadow-sm focus:border-sky-500 focus:ring-sky-500" required>
                </div>
                <div class="mb-4">
                    <label for="quantity" class="block text-sm font-medium text-slate-300">Quantidade</label>
                    <input type="number" id="quantity" name="quantity" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-white shadow-sm focus:border-sky-500 focus:ring-sky-500" required>
                </div>
                <div class="mb-4">
                    <label for="entryDate" class="block text-sm font-medium text-slate-300">Data de Entrada</label>
                    <input type="date" id="entryDate" name="entryDate" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-white shadow-sm focus:border-sky-500 focus:ring-sky-500" required>
                </div>
                 <div class="mb-4">
                    <label for="commercialAction" class="block text-sm font-medium text-slate-300">A√ß√£o Comercial Sugerida</label>
                    <input type="text" id="commercialAction" name="commercialAction" placeholder="Ex: Desconto 10%" class="mt-1 block w-full rounded-md border-slate-600 bg-slate-700 text-white shadow-sm focus:border-sky-500 focus:ring-sky-500">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancel-btn" class="bg-slate-600 text-slate-200 font-bold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors">Cancelar</button>
                    <button type="submit" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-500 transition-colors">Adicionar</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA & CONFIGURATION ---

            const COLUMNS = [
                { id: 'disponivel', title: 'Dispon√≠vel para Venda', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-seam" viewBox="0 0 16 16"><path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.41 2.322l-2.224-.89zM15 4.239l-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/></svg>` },
                { id: 'negociacao', title: 'Negocia√ß√£o / Oferta', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-tag" viewBox="0 0 16 16"><path d="M6 4.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-1 0a.5.5 0 1 0-1 0 .5.5 0 0 0 1 0z"/><path d="M2 1h4.586a1 1 0 0 1 .707.293l7 7a1 1 0 0 1 0 1.414l-4.586 4.586a1 1 0 0 1-1.414 0l-7-7A1 1 0 0 1 1 6.586V2a1 1 0 0 1 1-1zm0 5.586 7 7L13.586 9l-7-7H2v4.586z"/></svg>` },
                { id: 'faturamento', title: 'Faturamento', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-receipt" viewBox="0 0 16 16"><path d="M1.92.506a.5.5 0 0 1 .434.14L3 1.293l.646-.647a.5.5 0 0 1 .708 0L5 1.293l.646-.647a.5.5 0 0 1 .708 0L7 1.293l.646-.647a.5.5 0 0 1 .708 0L9 1.293l.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .801.13l.5 1A.5.5 0 0 1 15 2v12a.5.5 0 0 1-.053.224l-.5 1a.5.5 0 0 1-.8.13L13 14.707l-.646.647a.5.5 0 0 1-.708 0L11 14.707l-.646.647a.5.5 0 0 1-.708 0L9 14.707l-.646.647a.5.5 0 0 1-.708 0L7 14.707l-.646.647a.5.5 0 0 1-.708 0L5 14.707l-.646.647a.5.5 0 0 1-.708 0L3 14.707l-.646.647a.5.5 0 0 1-.801-.13l-.5-1A.5.5 0 0 1 1 14V2a.5.5 0 0 1 .053-.224l.5-1a.5.5 0 0 1 .367-.27zm.217 1.338L2 2.118v11.764l.137.274.51-.51a.5.5 0 0 1 .707 0l.646.647.646-.646a.5.5 0 0 1 .708 0l.646.646.646-.646a.5.5 0 0 1 .708 0l.646.646.646-.646a.5.5 0 0 1 .708 0l.646.646.646-.646a.5.5 0 0 1 .708 0l.646.646.646-.646a.5.5 0 0 1 .708 0l.509.509.137-.274V2.118l-.137-.274-.51.51a.5.5 0 0 1-.707 0L12 1.707l-.646.647a.5.5 0 0 1-.708 0L10 1.707l-.646.647a.5.5 0 0 1-.708 0L8 1.707l-.646.647a.5.5 0 0 1-.708 0L6 1.707l-.646.647a.5.5 0 0 1-.708 0L4 1.707l-.646.647a.5.5 0 0 1-.708 0l-.509-.51z"/><path d="M3 4.5a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5zm8-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5z"/></svg>` },
                { id: 'expedicao', title: 'Expedi√ß√£o', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-truck" viewBox="0 0 16 16"><path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-4 0a1.5 1.5 0 0 1-1.5-1.5V3.5zM1 4v6.5A.5.5 0 0 0 1.5 11h1.55a2.5 2.5 0 0 1 4.9 0H10a.5.5 0 0 0 .5-.5V4H1zM3.5 12a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm9 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-6.406-7L7.094 7.5h.01l.003.004l.014.017l.02.022l.02.02l.018.016l.017.014l.004.003l.002.001h.001l.494.494a.5.5 0 0 0 .707 0l1.414-1.414a.5.5 0 0 0-.707-.707L8.5 6.293 6.793 4.586a.5.5 0 0 0-.707.707z"/><path d="M11.5 4a.5.5 0 0 1 .5.5V5h1.5V4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1.379a.5.5 0 0 1-.146.354l-1.85 1.85a.5.5 0 0 1-.354.146H12.5a.5.5 0 0 1-.5-.5V4h-1z"/></svg>` },
                { id: 'concluido', title: 'Conclu√≠do', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2-circle" viewBox="0 0 16 16"><path d="M2.5 8a5.5 5.5 0 0 1 8.25-4.764.5.5 0 0 0 .5-.866A6.5 6.5 0 1 0 14.5 8a.5.5 0 0 0-1 0 5.5 5.5 0 1 1-11 0z"/><path d="M15.354 3.354a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l7-7z"/></svg>` }
            ];

            const URGENCY_LANES = [
                { id: 'ultima-chamada', name: '√öltima Chamada', minDays: 61, maxDays: Infinity, color: 'bg-red-600/30', textColor: 'text-red-200', borderColor: 'border-red-500' },
                { id: 'atencao-maxima', name: 'Aten√ß√£o M√°xima', minDays: 31, maxDays: 60, color: 'bg-orange-500/30', textColor: 'text-orange-200', borderColor: 'border-orange-500' },
                { id: 'zona-alerta', name: 'Zona de Alerta', minDays: 16, maxDays: 30, color: 'bg-yellow-500/30', textColor: 'text-yellow-200', borderColor: 'border-yellow-500' },
                { id: 'saida-normal', name: 'Sa√≠da Normal', minDays: 0, maxDays: 15, color: 'bg-green-500/30', textColor: 'text-green-200', borderColor: 'border-green-500' }
            ];

            let items = [
                { id: 1, photoUrl: 'https://placehold.co/100x100/38bdf8/0c4a6e?text=SKU-001', sku: 'SKU-001', quantity: 50, entryDate: '2025-06-10', status: 'disponivel', commercialAction: 'Sugerir em kit' },
                { id: 2, photoUrl: 'https://placehold.co/100x100/facc15/78350f?text=SKU-002', sku: 'SKU-002', quantity: 20, entryDate: '2025-08-01', status: 'disponivel', commercialAction: 'Desconto 5%' },
                { id: 3, photoUrl: 'https://placehold.co/100x100/f87171/7f1d1d?text=SKU-003', sku: 'SKU-003', quantity: 15, entryDate: '2025-05-20', status: 'negociacao', commercialAction: 'Campanha rel√¢mpago' },
                { id: 4, photoUrl: 'https://placehold.co/100x100/4ade80/064e3b?text=SKU-004', sku: 'SKU-004', quantity: 100, entryDate: '2025-08-15', status: 'disponivel', commercialAction: '' },
                { id: 5, photoUrl: 'https://placehold.co/100x100/fb923c/7c2d12?text=SKU-005', sku: 'SKU-005', quantity: 30, entryDate: '2025-07-15', status: 'faturamento', commercialAction: 'Venda casada' },
                { id: 6, photoUrl: 'https://placehold.co/100x100/4ade80/064e3b?text=SKU-006', sku: 'SKU-006', quantity: 200, entryDate: '2025-08-20', status: 'expedicao', commercialAction: '' },
                { id: 7, photoUrl: 'https://placehold.co/100x100/f87171/7f1d1d?text=SKU-007', sku: 'SKU-007', quantity: 5, entryDate: '2025-04-01', status: 'disponivel', commercialAction: 'Marketplace de saldos' },
            ];
            
            let movementHistory = [];

            const kanbanBoard = document.getElementById('kanban-board');
            const modal = document.getElementById('modal');
            const addItemBtn = document.getElementById('add-item-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const addItemForm = document.getElementById('add-item-form');
            const avgDaysInStockEl = document.getElementById('avgDaysInStock');
            const lastCallCountEl = document.getElementById('lastCallCount');
            const stockDistributionChartCanvas = document.getElementById('stockDistributionChart').getContext('2d');
            const historyLog = document.getElementById('history-log');
            const colorLegendList = document.getElementById('color-legend-list');
            let stockChart;

            const renderColorLegend = () => {
                colorLegendList.innerHTML = URGENCY_LANES.map(lane => `
                    <li class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full ${lane.color.replace('/30', '/80')} border ${lane.borderColor}"></div>
                        <div>
                            <span class="font-semibold ${lane.textColor}">${lane.name}:</span>
                            <span class="text-slate-400">${lane.minDays}${lane.maxDays === Infinity ? '+' : ' a ' + lane.maxDays} dias</span>
                        </div>
                    </li>
                `).join('');
            };

            const renderHistory = () => {
                if (movementHistory.length === 0) {
                    historyLog.innerHTML = '<p class="text-slate-500 italic">Nenhuma movimenta√ß√£o registrada.</p>';
                    return;
                }
                historyLog.innerHTML = movementHistory.map(log => {
                    const fromColumn = COLUMNS.find(c => c.id === log.from)?.title || log.from;
                    const toColumn = COLUMNS.find(c => c.id === log.to)?.title || log.to;
                    return `
                        <div class="bg-slate-700/50 p-2 rounded-md">
                            <p><span class="font-bold text-sky-400">${log.sku}</span> movido de</p>
                            <p class="pl-2"><span class="text-slate-400">"${fromColumn}"</span> para <span class="text-slate-400">"${toColumn}"</span></p>
                            <p class="text-right text-slate-500">${log.timestamp.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}</p>
                        </div>
                    `;
                }).join('');
            };
            
            const calculateDaysInStock = (dateString) => {
                const entryDate = new Date(dateString);
                const today = new Date();
                entryDate.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);
                const diffTime = Math.abs(today - entryDate);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            };

            const getUrgencyLane = (daysInStock) => {
                return URGENCY_LANES.find(lane => daysInStock >= lane.minDays && daysInStock <= lane.maxDays);
            };

            const createCardHTML = (item) => {
                const daysInStock = calculateDaysInStock(item.entryDate);
                const isOverdue = daysInStock > 60;
                
                return `
                    <div id="item-${item.id}" class="kanban-card bg-slate-700/50 p-3 rounded-lg shadow-md border-l-4 ${isOverdue ? 'card-overdue border-red-500' : 'border-slate-600'} cursor-grab" draggable="true">
                        <div class="flex items-start gap-3">
                            <img src="${item.photoUrl}" alt="Produto ${item.sku}" class="w-16 h-16 object-cover rounded-md flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/100x100/334155/e2e8f0?text=Error';">
                            <div class="flex-grow">
                                <p class="font-bold text-sm text-white">${item.sku}</p>
                                <p class="text-xs text-slate-400">Qtd: ${item.quantity}</p>
                                <p class="text-xs text-slate-400">Entrada: ${new Date(item.entryDate).toLocaleDateString('pt-BR')}</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-600">
                            <p class="text-center text-sm font-bold text-sky-300 bg-sky-800/50 rounded-full py-1 px-2">
                                ${daysInStock} dias
                            </p>
                            ${item.commercialAction ? `
                            <div class="mt-2 text-center text-xs text-fuchsia-300 bg-fuchsia-800/30 p-2 rounded-md">
                                <span class="font-semibold">A√ß√£o:</span> ${item.commercialAction}
                            </div>` : ''}
                        </div>
                    </div>
                `;
            };

            const renderBoard = () => {
                kanbanBoard.innerHTML = '';

                COLUMNS.forEach(column => {
                    const columnEl = document.createElement('div');
                    columnEl.id = column.id;
                    columnEl.className = 'bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700 shadow-lg';
                    
                    let lanesHTML = URGENCY_LANES.map(lane => `
                        <div class="p-3 rounded-lg ${lane.color} border ${lane.borderColor}">
                            <h3 class="font-bold text-sm mb-3 ${lane.textColor}">${lane.name}</h3>
                            <div id="${column.id}-${lane.id}" class="drop-zone space-y-3" data-column-id="${column.id}" data-lane-id="${lane.id}"></div>
                        </div>
                    `).join('');

                    columnEl.innerHTML = `
                        <div class="p-3 sticky top-0 bg-slate-800/80 backdrop-blur-sm rounded-t-xl z-10 border-b border-slate-700 flex items-center justify-center gap-2">
                           <span class="text-slate-400">${column.icon}</span>
                           <h2 class="text-sm font-extrabold text-center text-slate-300 uppercase tracking-wider">${column.title}</h2>
                        </div>
                        <div class="p-3 pt-0 flex flex-col gap-4">
                            ${lanesHTML}
                        </div>
                    `;
                    kanbanBoard.appendChild(columnEl);
                });

                items.forEach(item => {
                    const daysInStock = calculateDaysInStock(item.entryDate);
                    const urgencyLane = getUrgencyLane(daysInStock);
                    if (urgencyLane) {
                        const dropZone = document.getElementById(`${item.status}-${urgencyLane.id}`);
                        if (dropZone) {
                            dropZone.innerHTML += createCardHTML(item);
                        }
                    }
                });

                updateDashboard();
                addDragAndDropListeners();
            };
            
            const updateDashboard = () => {
                const totalDays = items.reduce((sum, item) => sum + calculateDaysInStock(item.entryDate), 0);
                const avgDays = items.length > 0 ? (totalDays / items.length).toFixed(1) : 0;
                avgDaysInStockEl.textContent = avgDays;
                
                const lastCallItems = items.filter(item => calculateDaysInStock(item.entryDate) > 60);
                lastCallCountEl.textContent = lastCallItems.length;

                const laneCounts = URGENCY_LANES.map(lane => {
                    return items.filter(item => {
                        const days = calculateDaysInStock(item.entryDate);
                        return days >= lane.minDays && days <= lane.maxDays;
                    }).length;
                }).reverse();

                const chartLabels = URGENCY_LANES.map(lane => lane.name).reverse();
                const chartColors = URGENCY_LANES.map(lane => {
                    if(lane.id === 'saida-normal') return '#22c55e'; 
                    if(lane.id === 'zona-alerta') return '#f59e0b'; 
                    if(lane.id === 'atencao-maxima') return '#f97316';
                    if(lane.id === 'ultima-chamada') return '#ef4444';
                }).reverse();

                if (stockChart) {
                    stockChart.data.labels = chartLabels;
                    stockChart.data.datasets[0].data = laneCounts;
                    stockChart.update();
                } else {
                    stockChart = new Chart(stockDistributionChartCanvas, {
                        type: 'doughnut',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                data: laneCounts,
                                backgroundColor: chartColors,
                                borderColor: '#1e293b',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { 
                                    position: 'top',
                                    labels: {
                                        color: '#cbd5e1'
                                    }
                                },
                            }
                        }
                    });
                }
            };

            function addDragAndDropListeners() {
                const cards = document.querySelectorAll('.kanban-card');
                const dropZones = document.querySelectorAll('.drop-zone');

                cards.forEach(card => {
                    card.addEventListener('dragstart', (e) => {
                        card.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', card.id);
                    });
                    card.addEventListener('dragend', () => card.classList.remove('dragging'));
                });

                dropZones.forEach(zone => {
                    zone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        zone.classList.add('drag-over');
                    });
                    zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
                    zone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        zone.classList.remove('drag-over');
                        const cardId = e.dataTransfer.getData('text/plain');
                        const itemId = parseInt(cardId.replace('item-', ''));
                        const targetColumnId = zone.dataset.columnId;
                        const itemToMove = items.find(item => item.id === itemId);
                        
                        if (itemToMove && itemToMove.status !== targetColumnId) {
                            const sourceColumnId = itemToMove.status;

                            const historyEntry = {
                                itemId: itemToMove.id,
                                sku: itemToMove.sku,
                                from: sourceColumnId,
                                to: targetColumnId,
                                timestamp: new Date()
                            };
                            movementHistory.unshift(historyEntry);
                            if (movementHistory.length > 20) {
                                movementHistory.pop();
                            }

                            itemToMove.status = targetColumnId;
                            renderBoard();
                            renderHistory();
                        }
                    });
                });
            }

            const showModal = () => modal.classList.remove('hidden');
            const hideModal = () => modal.classList.add('hidden');

            addItemBtn.addEventListener('click', showModal);
            cancelBtn.addEventListener('click', hideModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) hideModal(); });

            addItemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(addItemForm);
                const newItem = {
                    id: Date.now(),
                    photoUrl: `https://placehold.co/100x100/60a5fa/1e3a8a?text=${formData.get('sku')}`,
                    sku: formData.get('sku'),
                    quantity: parseInt(formData.get('quantity')),
                    entryDate: formData.get('entryDate'),
                    status: 'disponivel',
                    commercialAction: formData.get('commercialAction')
                };
                items.push(newItem);
                addItemForm.reset();
                hideModal();
                renderBoard();
            });

            // Initial Renders
            renderBoard();
            renderHistory();
            renderColorLegend();
        });
    </script>

</body>
</html>

